<!doctype html>
<html lang="ar" dir="rtl">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù…Ø´Ø§Ù‡Ø¯Ø© Ø¬Ù…Ø§Ø¹ÙŠØ©</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  
  <script type="module">
    // Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¬Ù…ÙŠØ¹ ÙˆØ¸Ø§Ø¦Ù Firebase Ø§Ù„Ù„Ø§Ø²Ù…Ø©
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, orderBy, where, addDoc, deleteDoc, runTransaction, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; // ØªÙ… Ø¥Ø¶Ø§ÙØ© getDocs Ù‡Ù†Ø§
    import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject, uploadBytesResumable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    // ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© Ù„ØªÙ…ÙƒÙŠÙ† Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§ ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø£Ù†Ø­Ø§Ø¡ Ø§Ù„ÙƒÙˆØ¯
    window.firebase = {
        initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, updateProfile,
        getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, orderBy, where, addDoc, deleteDoc, runTransaction, getDocs, // ØªÙ… Ø¥Ø¶Ø§ÙØ© getDocs Ù‡Ù†Ø§
        getStorage, ref, uploadBytes, getDownloadURL, deleteObject, uploadBytesResumable, setLogLevel
    };
  </script>
  
  <style>
        body {
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }
        
        /* Ù†Ù…Ø· Ù„Ø®Ù„ÙÙŠØ© ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© */
        .avatar-pattern {
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
        }
        
        .chat-message {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .menu-overlay {
            backdrop-filter: blur(4px);
        }
        
        /* ÙˆØ¶Ø¹ Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø© Ù„Ù„ÙÙŠØ¯ÙŠÙˆ */
        .fullscreen-video {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1000;
            background: black;
            display: flex; 
            justify-content: center;
            align-items: center;
        }

        .fullscreen-video > video {
            max-width: 100%;
            max-height: 100%;
        }
        
        /* ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ù…ØµØºØ± ÙÙŠ Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø© */
        .fullscreen-chat-swipe { 
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1001;
            max-height: 40vh; 
            overflow-y: auto;
            border-top-left-radius: 1rem;
            border-top-right-radius: 1rem;
        }
        
        /* Ø²Ø± Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ÙÙŠ ÙˆØ¶Ø¹ Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø© */
        .chat-toggle-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            z-index: 1002;
            background-color: rgba(255, 255, 255, 0.1);
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 min-h-full text-white"><div id="loginScreen" class="min-h-full flex items-center justify-center p-4">
   <div class="bg-white/10 backdrop-blur-lg rounded-3xl p-8 w-full max-w-md shadow-2xl border border-white/20">
    <div class="text-center mb-8">
     <h1 id="appTitle" class="text-3xl font-bold mb-2 bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">Ù…Ø´Ø§Ù‡Ø¯Ø© Ø¬Ù…Ø§Ø¹ÙŠØ©</h1>
     <p id="welcomeMessage" class="text-gray-300">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ©</p>
    </div>
    <div class="space-y-6">
     <div><label class="block text-sm font-medium mb-2">Ø§Ù„Ø§Ø³Ù…</label> <input type="text" id="userName" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 text-white placeholder-gray-400" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ">
     </div>
     <div><label class="block text-sm font-medium mb-2">ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label> <input type="file" id="avatarInput" accept="image/*" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 text-white file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-purple-600 file:text-white file:cursor-pointer">
     </div>
     <div class="text-center">
      <div id="avatarPreview" class="w-20 h-20 rounded-full mx-auto mb-4 avatar-pattern flex items-center justify-center text-2xl font-bold">
       ğŸ‘¤
      </div>
     </div><button id="continueBtn" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 py-3 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105">Ù…ØªØ§Ø¨Ø¹Ø©</button>
    </div>
   </div>
  </div><div id="createRoomScreen" class="hidden min-h-full flex items-center justify-center p-4">
   <div class="bg-white/10 backdrop-blur-lg rounded-3xl p-8 w-full max-w-md shadow-2xl border border-white/20">
    <h2 class="text-2xl font-bold text-center mb-6">Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©</h2>
    <div class="space-y-6">
     <div><label class="block text-sm font-medium mb-2">Ø§Ø®ØªØ± Ù…Ù„Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (Ø­Ø¬Ù… ÙƒØ¨ÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…)</label> <input type="file" id="videoInput" accept="video/*" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 text-white file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-purple-600 file:text-white file:cursor-pointer">
     </div><button id="createRoomBtn" class="w-full bg-gradient-to-r from-green-600 to-blue-600 hover:from-green-700 hover:to-blue-700 py-3 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed" disabled>Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©</button>
     
     <div id="progressContainer" class="hidden mt-4">
         <div class="text-sm font-medium mb-1 text-gray-300 flex justify-between">
             <span>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...</span>
             <span id="uploadPercentage">0%</span>
         </div>
         <div class="w-full bg-gray-700 rounded-full h-2.5">
             <div id="progressBar" class="bg-green-500 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
         </div>
     </div>
     <div id="progressMessage" class="text-center text-sm text-gray-300 hidden"></div>
    </div>
   </div>
  </div><div id="roomScreen" class="hidden min-h-full flex flex-col">
    <div id="compactChat" class="fixed top-0 bottom-0 left-0 w-80 bg-black/80 backdrop-blur-lg z-[1001] transition-transform duration-300 ease-in-out transform -translate-x-full hidden md:w-96">
        <div class="h-full flex flex-col">
            <div class="p-4 flex justify-between items-center border-b border-white/10">
                <h3 class="text-lg font-semibold">Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© (Ø´Ø§Ø´Ø© ÙƒØ§Ù…Ù„Ø©)</h3>
                <button id="closeCompactChatBtn" class="p-1 hover:bg-white/20 rounded-full transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="compactChatMessages" class="flex-1 overflow-y-auto p-4 space-y-3"></div>
            <div class="p-4 border-t border-white/10">
                <div class="flex space-x-2 space-x-reverse">
                    <input type="text" id="compactMessageInput" class="flex-1 px-4 py-2 bg-white/10 border border-white/20 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 text-white placeholder-gray-400" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©...">
                    <button id="sendCompactBtn" class="bg-purple-600 hover:bg-purple-700 px-6 py-2 rounded-xl font-semibold transition-colors">Ø¥Ø±Ø³Ø§Ù„</button>
                </div>
            </div>
        </div>
    </div>
    <div class="bg-black/50 backdrop-blur-lg p-4 flex justify-between items-center border-b border-white/10"><button id="menuBtn" class="p-2 hover:bg-white/10 rounded-lg transition-colors">
     <div class="w-6 h-6 flex flex-col justify-center space-y-1">
      <div class="w-full h-0.5 bg-white"></div>
      <div class="w-full h-0.5 bg-white"></div>
      <div class="w-full h-0.5 bg-white"></div>
     </div></button>
    
    <button id="openParticipantsBtn" class="flex items-center space-x-1 space-x-reverse p-2 hover:bg-white/10 rounded-lg transition-colors">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5m-5 0a2 2 0 100-4m0 4a2 2 0 110-4m-1-9H10a4 4 0 00-4 4v2m.28 10a5.98 5.98 0 001.28-.97m8.26-10l2.67 2.67c.56.56.76 1.34.76 2.06v4.33a2 2 0 01-2 2H6a2 2 0 01-2-2v-4.33c0-.72.2-1.5.76-2.06L6 9.22"/></svg>
        <span id="participantsCount" class="font-bold text-sm bg-red-600 rounded-full w-6 h-6 flex items-center justify-center">0</span>
    </button>
    
    <div class="flex items-center space-x-2 space-x-reverse"><span id="roomUserName" class="font-semibold text-sm sm:text-base"></span>
     <div id="roomUserAvatar" class="w-8 h-8 rounded-full avatar-pattern flex items-center justify-center text-sm font-bold">
      ğŸ‘¤
     </div>
    </div>
    <button id="fullscreenBtn" class="p-2 hover:bg-white/10 rounded-lg transition-colors hidden">
     <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
     </svg>
    </button>
   </div>
   
   <div id="videoContainer" class="flex-1 bg-black relative transition-transform duration-300 ease-in-out p-4">
        <div id="videoWrapper" class="relative w-full" style="padding-top: 56.25%;">
            <video id="mainVideo" class="absolute top-0 left-0 w-full h-full object-cover" crossorigin="anonymous" playsinline></video>
        </div>
        
        <button id="chatToggleBtn" class="chat-toggle-btn p-2 rounded-full hidden" aria-label="Toggle Chat">
         <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.505A9.76 9.76 0 0112 4c4.97 0 9 3.582 9 8z" />
         </svg></button>
         
         <div id="hostControls" class="absolute bottom-4 left-0 right-0 p-4 rounded-t-lg hidden flex justify-center">
             <div class="flex space-x-4 space-x-reverse bg-black/50 p-3 rounded-full">
                 
                 <button id="rewindBtn" class="bg-white/20 hover:bg-white/30 p-3 rounded-full transition-colors" title="ØªØ£Ø®ÙŠØ± 10 Ø«ÙˆØ§Ù†ÙŠ">
                   <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12 5V2L8 6l4 4V7c3.31 0 6 2.69 6 6s-2.69 6-6 6a5.996 5.996 0 01-5.12-2.88L3.46 17.5c2.11 3.59 5.86 6 10.04 6 6.07 0 11-4.93 11-11S18.07 2 12 2z"/></svg>
                </button>
                 
                <button id="playPauseBtn" class="bg-white/20 hover:bg-white/30 p-3 rounded-full transition-colors">
                   <svg class="w-6 h-6" fill="currentColor" viewbox="0 0 24 24"><path d="M8 5v14l11-7z" /></svg>
                </button>
                 
                <button id="forwardBtn" class="bg-white/20 hover:bg-white/30 p-3 rounded-full transition-colors" title="ØªÙ‚Ø¯ÙŠÙ… 10 Ø«ÙˆØ§Ù†ÙŠ">
                   <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12 19V22l4-4-4-4v3c-3.31 0-6-2.69-6-6s2.69-6 6-6a5.996 5.996 0 015.12 2.88L20.54 6.5c-2.11-3.59-5.86-6-10.04-6-6.07 0-11 4.93-11 11s4.93 11 11 11z"/></svg>
                </button>
             </div>
         </div>
   </div>
  </div>
  
  <div id="chatContainer" class="fixed inset-x-0 bottom-0 bg-black/30 backdrop-blur-lg border-t border-white/10 z-20 hidden flex flex-col max-h-[80vh]">
    <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-3"></div>
    <div class="p-4 border-t border-white/10">
     <div class="flex space-x-2 space-x-reverse"><input type="text" id="messageInput" class="flex-1 px-4 py-2 bg-white/10 border border-white/20 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 text-white placeholder-gray-400" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..."> <button id="sendBtn" class="bg-purple-600 hover:bg-purple-700 px-6 py-2 rounded-xl font-semibold transition-colors">Ø¥Ø±Ø³Ø§Ù„</button>
     </div>
    </div>
  </div>
  
  <div id="menuOverlay" class="hidden fixed inset-0 menu-overlay z-50">
   <div class="absolute top-16 right-4 bg-white/10 backdrop-blur-lg rounded-2xl p-4 min-w-48 shadow-2xl border border-white/20">
    <div class="flex justify-end pb-2">
        <button id="closeMenuBtn" class="p-1 hover:bg-white/20 rounded-full transition-colors">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
    </div>
    <div class="space-y-2">
        <button id="copyLinkBtn" class="w-full text-right p-3 hover:bg-white/10 rounded-lg transition-colors">Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„ØºØ±ÙØ©</button> 
        <button id="showVideosBtn" class="w-full text-right p-3 hover:bg-white/10 rounded-lg transition-colors">Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ù…Ø­Ù…Ù„Ø©</button> <button id="changeNameBtn" class="w-full text-right p-3 hover:bg-white/10 rounded-lg transition-colors">ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù…</button> 
        <button id="changeAvatarBtn" class="w-full text-right p-3 hover:bg-white/10 rounded-lg transition-colors">ØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØ±Ø©</button>
        <button id="deleteRoomBtn" class="w-full text-right p-3 hover:bg-red-500/20 text-red-400 rounded-lg transition-colors hidden">Ø­Ø°Ù Ø§Ù„ØºØ±ÙØ©</button>
        <button id="leaveRoomBtn" class="w-full text-right p-3 hover:bg-red-500/20 text-red-400 rounded-lg transition-colors">Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„ØºØ±ÙØ©</button>
    </div>
   </div>
  </div><div id="changeNameModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
   <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 w-full max-w-sm">
    <h3 class="text-xl font-bold mb-4">ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù…</h3><input type="text" id="newNameInput" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 text-white placeholder-gray-400 mb-4" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯">
    <div class="flex space-x-2 space-x-reverse"><button id="saveNameBtn" class="flex-1 bg-purple-600 hover:bg-purple-700 py-2 rounded-lg transition-colors">Ø­ÙØ¸</button> <button id="cancelNameBtn" class="flex-1 bg-gray-600 hover:bg-gray-700 py-2 rounded-lg transition-colors">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
   </div>
  </div><div id="changeAvatarModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
   <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 w-full max-w-sm">
    <h3 class="text-xl font-bold mb-4">ØªØºÙŠÙŠØ± ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„</h3><input type="file" id="newAvatarInput" accept="image/*" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 text-white file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-purple-600 file:text-white file:cursor-pointer mb-4">
    <div class="flex space-x-2 space-x-reverse"><button id="saveAvatarBtn" class="flex-1 bg-purple-600 hover:bg-purple-700 py-2 rounded-lg transition-colors">Ø­ÙØ¸</button> <button id="cancelAvatarBtn" class="flex-1 bg-gray-600 hover:bg-gray-700 py-2 rounded-lg transition-colors">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
   </div>
  </div><div id="deleteConfirmModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
   <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 w-full max-w-sm">
    <h3 class="text-xl font-bold mb-4">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</h3>
    <p id="deleteConfirmMessage" class="mb-6">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ Ø­Ø°Ù Ø§Ù„ØºØ±ÙØ©ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ù…Ù„Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù….</p>
    <div class="flex space-x-2 space-x-reverse"><button id="confirmDeleteBtn" class="flex-1 bg-red-600 hover:bg-red-700 py-2 rounded-lg transition-colors">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</button> <button id="cancelDeleteBtn" class="flex-1 bg-gray-600 hover:bg-gray-700 py-2 rounded-lg transition-colors">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
   </div>
  </div>
  <div id="participantsModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
    <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 w-full max-w-sm max-h-[80vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙˆÙ† (<span id="modalParticipantsCount">0</span>)</h3>
            <button id="closeParticipantsBtn" class="p-1 rounded-full hover:bg-white/20 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <div id="participantsList" class="space-y-3">
            </div>
    </div>
  </div>
  
  <div id="videosModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
    <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 w-full max-w-sm max-h-[80vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ù…Ø­Ù…Ù„Ø©</h3>
            <button id="closeVideosBtn" class="p-1 rounded-full hover:bg-white/20 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <div id="videosList" class="space-y-4">
            </div>
        
        <div class="mt-6">
            <input type="file" id="additionalVideoInput" accept="video/*" class="hidden">
            <button id="addVideoBtn" class="w-full bg-green-600 hover:bg-green-700 py-3 rounded-xl font-semibold transition-colors disabled:opacity-50 disabled:cursor-not-allowed">Ø¥Ø¶Ø§ÙØ© ÙÙŠØ¯ÙŠÙˆ</button>
        </div>
    </div>
  </div>

  <script type="module">
        // Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆØ¸Ø§Ø¦Ù Firebase Ù…Ù† Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ø§Ù… Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
        const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, 
                getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, orderBy, where, addDoc, deleteDoc, 
                getStorage, ref, uploadBytes, getDownloadURL, deleteObject, uploadBytesResumable, setLogLevel, updateProfile, getDocs } = window.firebase;
        
        // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„Ø­Ø§Ù„Ø© Ùˆ Firebase
        let currentUser = null;
        let currentRoomId = null;
        let isHost = false;
        let isFullscreen = false;
        let chatVisible = true;
        let videoFile = null;
        let videoUrl = null;
        let roomHostIdCache = null; 
        let currentVideoId = null; // Ø¬Ø¯ÙŠØ¯: ID Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø°ÙŠ ÙŠØªÙ… ØªØ´ØºÙŠÙ„Ù‡ Ø­Ø§Ù„ÙŠÙ‹Ø§
        let currentUploads = {}; // Ø¬Ø¯ÙŠØ¯: Ù„ØªØªØ¨Ø¹ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø±ÙØ¹ Ø§Ù„Ø¬Ø§Ø±ÙŠØ© ÙˆØ´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…

        // Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø­Ø¨ (Swipe) Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        let startX = 0;
        let isSwiping = false;
        const swipeThreshold = 50; // Ø¨ÙƒØ³Ù„ Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙ…Ø±ÙŠØ±
        const COMPACT_CHAT_WIDTH = 320; 

        let db;
        let auth;
        let storage;
        let userId = null;
        let unsubscribes = []; // Ù„ØªØ®Ø²ÙŠÙ† Ø¯ÙˆØ§Ù„ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù…Ù† onSnapshot

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; 
        
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Ø§Ù„ØªÙŠ Ù‚Ø¯Ù…ØªÙ‡Ø§ (ÙƒÙ†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… ØªÙˆÙÙŠØ± Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©)
        const userConfig = {
            apiKey: "AIzaSyAcIwwapktH2nxyZczVKFacTrLh1o-EgdM",
            authDomain: "shakkak-8f90f.firebaseapp.com",
            projectId: "shakkak-8f90f",
            storageBucket: "shakkak-8f90f.firebasestorage.app",
            messagingSenderId: "1039276785290",
            appId: "1:1039276785290:web:ed874a451b37fb3210f773",
            measurementId: "G-QRH0Z1HM5R"
        };
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ© Ø¥Ù† ÙˆØ¬Ø¯ØªØŒ ÙˆØ¥Ù„Ø§ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        const externalConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const firebaseConfig = Object.keys(externalConfig).length > 0 ? externalConfig : userConfig;


        const ROOM_STATUS_ACTIVE = 'active';
        const ROOM_STATUS_ENDED = 'ended';

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        async function initApp() {
            // 1. ØªÙ‡ÙŠØ¦Ø© Firebase
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                storage = getStorage(app);
                setLogLevel('Debug'); // ØªÙØ¹ÙŠÙ„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ Ø§Ù„ØªØµØ­ÙŠØ­

                // 2. Ù…Ø³ØªÙ…Ø¹ Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© (Auth Listener)
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        await loadUserProfile(); // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                        
                        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„ØºØ±ÙØ© Ù…Ù† Ø±Ø§Ø¨Ø· URL Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§
                        const urlParams = new URLSearchParams(window.location.search);
                        const roomIdFromUrl = urlParams.get('room');
                        
                        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‚Ø¯ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ù‡
                        if (currentUser && currentUser.name) {
                            if (roomIdFromUrl) {
                                // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ ÙˆÙ„Ø¯ÙŠÙ‡ Ø§Ø³Ù…ØŒ ÙŠÙ†Ø¶Ù… Ù…Ø¨Ø§Ø´Ø±Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø±Ø§Ø¨Ø·
                                await attemptJoinRoom(roomIdFromUrl);
                            } else {
                                // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ ÙˆÙ„Ø¯ÙŠÙ‡ Ø§Ø³Ù…ØŒ ÙŠØ°Ù‡Ø¨ Ù„Ø´Ø§Ø´Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©
                                showCreateRoomScreen();
                            }
                        } else {
                             // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø§Ù„Ø§Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ØŒ Ù†Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø¥ÙƒÙ…Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡ (Ø­ØªÙ‰ Ù„Ùˆ Ø¬Ø§Ø¡ Ù…Ù† Ø±Ø§Ø¨Ø· Ø¯Ø¹ÙˆØ©)
                            showLoginScreen();
                        }
                    } else {
                        // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ù…Ø®ØµØµ Ø£Ùˆ ÙƒÙ…Ø¬Ù‡ÙˆÙ„
                        const customToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                        if (customToken) {
                            await signInWithCustomToken(auth, customToken).catch(e => console.error("Custom token sign in failed:", e));
                        } else {
                            await signInAnonymously(auth).catch(e => console.error("Anonymous sign in failed:", e));
                        }
                    }
                });

                // 3. Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
                setupEventListeners();
                
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showToast('ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø®Ø¯Ù…Ø© Firebase');
            }
        }

        // Ù…Ø³Ø§Ø± Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù„Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firestore
        function getUserProfileRef() {
            return doc(db, `/artifacts/${appId}/users/${userId}/profiles/main`);
        }

        // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Firestore
        async function loadUserProfile() {
            if (!userId) return;
            try {
                const docRef = getUserProfileRef();
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    currentUser = docSnap.data();
                } else {
                    // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø¨Ø±ÙˆÙØ§ÙŠÙ„ ÙÙŠ FirestoreØŒ Ù†Ø£Ø®Ø° Ù…Ù† localStorage ÙˆÙ†Ø­Ø§ÙˆÙ„ Ø¥Ù†Ø´Ø§Ø¡Ù‡
                    const savedUser = localStorage.getItem('watchPartyUser');
                    if (savedUser) {
                        currentUser = JSON.parse(savedUser);
                        currentUser.id = userId;
                        await saveUserProfile(currentUser); // Ø­ÙØ¸Ù‡ ÙÙŠ Firestore
                    } else {
                        currentUser = { id: userId, name: '', avatar: null };
                    }
                }
                // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                document.getElementById('userName').value = currentUser.name || '';
                updatePreviewAvatar(currentUser.avatar);

            } catch (error) {
                console.error("Error loading user profile:", error);
            }
        }

        // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firestore
        async function saveUserProfile(data) {
            if (!userId || !data) return;
            
            currentUser = { ...currentUser, ...data, id: userId };
            
            try {
                const docRef = getUserProfileRef();
                await setDoc(docRef, currentUser, { merge: true });
                localStorage.setItem('watchPartyUser', JSON.stringify(currentUser)); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ Cache
                updateUserAvatar(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø© ÙÙŠ Ø´Ø§Ø´Ø© Ø§Ù„ØºØ±ÙØ©
            } catch (error) {
                console.error("Error saving user profile:", error);
                showToast('ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© ÙÙŠ Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ - ØªÙ… ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§
        function updatePreviewAvatar(avatarUrl) {
            const previewEl = document.getElementById('avatarPreview');
            // Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· ÙØ¦Ø© Ø§Ù„Ù†Ù…Ø· Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
            previewEl.className = 'w-20 h-20 rounded-full mx-auto mb-4 avatar-pattern flex items-center justify-center text-2xl font-bold';
            
            if (avatarUrl && avatarUrl.startsWith('data:')) { // Ø¥Ø°Ø§ ÙƒØ§Ù† URL Ù…Ø¤Ù‚Øª (Ù…Ù† file reader)
                previewEl.innerHTML = `<img src="${avatarUrl}" class="w-full h-full object-cover rounded-full">`;
                previewEl.classList.remove('avatar-pattern'); // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù†Ù…Ø· Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ ØµÙˆØ±Ø©
            } else if (avatarUrl) { // Ø¥Ø°Ø§ ÙƒØ§Ù† URL Ø¯Ø§Ø¦Ù… (Ù…Ù† Firebase Storage)
                 previewEl.innerHTML = `<img src="${avatarUrl}" class="w-full h-full object-cover rounded-full">`;
                 previewEl.classList.remove('avatar-pattern'); // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù†Ù…Ø· Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ ØµÙˆØ±Ø©
            } else {
                previewEl.innerHTML = 'ğŸ‘¤';
                previewEl.classList.add('avatar-pattern'); // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ù…Ø· Ø¹Ù†Ø¯ Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ ØµÙˆØ±Ø©
            }
        }

        // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« (ØªÙ… Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ù…Ø­Ù…Ù„Ø©)
        function setupEventListeners() {
            // Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
            document.getElementById('continueBtn').addEventListener('click', handleLogin);
            document.getElementById('avatarInput').addEventListener('change', handleAvatarUpload);
            
            // Ø´Ø§Ø´Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©
            document.getElementById('videoInput').addEventListener('change', handleVideoUpload);
            document.getElementById('createRoomBtn').addEventListener('click', createRoom);
            
            // Ø´Ø§Ø´Ø© Ø§Ù„ØºØ±ÙØ©
            document.getElementById('menuBtn').addEventListener('click', toggleMenu);
            document.getElementById('openParticipantsBtn').addEventListener('click', showParticipantsModal); // Ø¬Ø¯ÙŠØ¯: Ø²Ø± Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†
            document.getElementById('chatToggleBtn').addEventListener('click', toggleChatVisibility);
            document.getElementById('sendBtn').addEventListener('click', sendMessage);
            document.getElementById('messageInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });
            
            // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª)
            document.getElementById('closeMenuBtn').addEventListener('click', hideMenu); // Ø¬Ø¯ÙŠØ¯: Ø²Ø± Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
            document.getElementById('copyLinkBtn').addEventListener('click', copyRoomLink);
            document.getElementById('showVideosBtn').addEventListener('click', showVideosModal); // Ø¬Ø¯ÙŠØ¯: Ø²Ø± Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ù…Ø­Ù…Ù„Ø©
            document.getElementById('changeNameBtn').addEventListener('click', showChangeNameModal);
            document.getElementById('changeAvatarBtn').addEventListener('click', showChangeAvatarModal);
            document.getElementById('deleteRoomBtn').addEventListener('click', handleDeleteRoom); // Ø²Ø± Ø­Ø°Ù Ø§Ù„ØºØ±ÙØ©
            document.getElementById('leaveRoomBtn').addEventListener('click', leaveRoom);
            
            // Ù†ÙˆØ§ÙØ° Ø§Ù„ØªØºÙŠÙŠØ± ÙˆØ§Ù„ØªØ£ÙƒÙŠØ¯
            document.getElementById('saveNameBtn').addEventListener('click', saveName);
            document.getElementById('cancelNameBtn').addEventListener('click', hideChangeNameModal);
            document.getElementById('saveAvatarBtn').addEventListener('click', saveAvatar);
            document.getElementById('cancelAvatarBtn').addEventListener('click', hideChangeAvatarModal);
            document.getElementById('newAvatarInput').addEventListener('change', handleNewAvatarUpload);
            document.getElementById('confirmDeleteBtn').addEventListener('click', handleDeleteRoomConfirmed);
            document.getElementById('cancelDeleteBtn').addEventListener('click', hideDeleteConfirmModal);
            
            // Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†
            document.getElementById('closeParticipantsBtn').addEventListener('click', hideParticipantsModal);
            
            // Ù†Ø§ÙØ°Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ù…Ø­Ù…Ù„Ø© (Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©)
            document.getElementById('closeVideosBtn').addEventListener('click', hideVideosModal);
            document.getElementById('addVideoBtn').addEventListener('click', () => document.getElementById('additionalVideoInput').click());
            document.getElementById('additionalVideoInput').addEventListener('change', handleAdditionalVideoUpload);

            // Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ù…ØµØºØ±Ø© (Swipe Chat)
            document.getElementById('closeCompactChatBtn').addEventListener('click', hideCompactChat);
            document.getElementById('sendCompactBtn').addEventListener('click', sendCompactMessage);
            document.getElementById('compactMessageInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendCompactMessage();
            });


            // Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù„Ù„Ù…Ù†Ø´Ø¦
            document.getElementById('playPauseBtn').addEventListener('click', togglePlayPause);
            document.getElementById('rewindBtn').addEventListener('click', () => seekVideo(-10)); 
            document.getElementById('forwardBtn').addEventListener('click', () => seekVideo(10)); 
            
            // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„Ù„Ù…Ø³ Ù„Ø­Ø±ÙƒØ© Ø§Ù„Ø³Ø­Ø¨ (Swipe)
            const videoContainer = document.getElementById('videoContainer');
            videoContainer.addEventListener('touchstart', handleTouchStart);
            videoContainer.addEventListener('touchmove', handleTouchMove, { passive: false }); 
            videoContainer.addEventListener('touchend', handleTouchEnd);
        }

        // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ù„Ù…Ø³ (Swipe) ---
        
        function handleTouchStart(e) {
            if (isFullscreen && e.touches.length === 1) { 
                startX = e.touches[0].clientX;
                isSwiping = true;
            }
        }

        function handleTouchMove(e) {
            if (!isFullscreen || !isSwiping) return;

            const diffX = e.touches[0].clientX - startX;
            
            // Ù…Ù†Ø¹ Ø§Ù„Ø³Ù„ÙˆÙƒ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø­Ø±ÙƒØ© Ø£ÙÙ‚ÙŠØ© ÙƒØ¨ÙŠØ±Ø© (Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø¹Ø§Ø¯ÙŠ)
            if (Math.abs(diffX) > 10) {
                e.preventDefault();
            }
        }

        function handleTouchEnd(e) {
            if (!isFullscreen || !isSwiping) return;
            
            const endX = e.changedTouches[0].clientX;
            const diffX = endX - startX;
            isSwiping = false;

            const isCompactChatVisible = !document.getElementById('compactChat').classList.contains('-translate-x-full');

            // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„ÙŠÙ…ÙŠÙ† Ù„ÙØªØ­ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© (ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…Ø®ÙÙŠØ©)
            if (diffX > swipeThreshold && !isCompactChatVisible) {
                showCompactChat();
            } 
            // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„ÙŠØ³Ø§Ø± Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© (ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…Ø±Ø¦ÙŠØ©)
            else if (diffX < -swipeThreshold && isCompactChatVisible) {
                hideCompactChat();
            }
        }
        
        function showCompactChat() {
            if (!isFullscreen) return;
            const chatEl = document.getElementById('compactChat');
            const videoEl = document.getElementById('videoContainer');
            
            chatEl.classList.remove('hidden');
            
            // ØªØ­Ø±ÙŠÙƒ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¥Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ† Ø¨Ù…Ù‚Ø¯Ø§Ø± Ø¹Ø±Ø¶ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ù…ØµØºØ±Ø©
            videoEl.style.transform = `translateX(${COMPACT_CHAT_WIDTH}px)`; 
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ù…ØµØºØ±Ø©
            setTimeout(() => {
                chatEl.classList.remove('-translate-x-full');
            }, 10);
            document.body.classList.add('overflow-hidden'); 
        }

        function hideCompactChat() {
            const chatEl = document.getElementById('compactChat');
            const videoEl = document.getElementById('videoContainer');

            // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù„ÙˆØ¶Ø¹Ù‡ Ø§Ù„Ø£ØµÙ„ÙŠ
            videoEl.style.transform = `translateX(0)`;
            
            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ù…ØµØºØ±Ø©
            chatEl.classList.add('-translate-x-full');
            document.body.classList.remove('overflow-hidden');
            
            // Ø¥Ø®ÙØ§Ø¦Ù‡Ø§ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ (300ms)
            setTimeout(() => {
                chatEl.classList.add('hidden');
            }, 300);
        }

        function sendCompactMessage() {
            const input = document.getElementById('compactMessageInput');
            const message = input.value.trim();
            if (!message) return;

            // Ù†Ø³ØªØ®Ø¯Ù… Ù†ÙØ³ Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
            document.getElementById('messageInput').value = message;
            sendMessage();
            input.value = ''; // Ù…Ø³Ø­ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
        }


        // --- ÙˆØ¸Ø§Ø¦Ù Ø¹Ø§Ù…Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© ---

        function showToast(message) {
            const toastContainer = document.querySelector('.toast-container');
            if (!toastContainer) {
                const container = document.createElement('div');
                container.className = 'toast-container fixed top-4 inset-x-0 flex justify-center z-[5000] space-x-2 space-x-reverse pointer-events-none';
                document.body.appendChild(container);
            }
            
            const toast = document.createElement('div');
            toast.className = 'bg-purple-600 text-white px-6 py-3 rounded-xl shadow-xl transition-opacity duration-300 opacity-0 transform translate-y-4 max-w-xs text-center pointer-events-auto';
            toast.textContent = message;

            document.querySelector('.toast-container').appendChild(toast);

            // Show animation
            setTimeout(() => {
                toast.classList.remove('opacity-0', 'translate-y-4');
                toast.classList.add('opacity-100', 'translate-y-0');
            }, 10);

            // Hide animation
            setTimeout(() => {
                toast.classList.remove('opacity-100', 'translate-y-0');
                toast.classList.add('opacity-0', 'translate-y-4');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function generateId(length = 20) {
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return result;
        }

        function showScreen(screenId) {
            const screens = ['loginScreen', 'createRoomScreen', 'roomScreen'];
            screens.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    if (id === screenId) {
                        el.classList.remove('hidden');
                        el.classList.add('flex');
                    } else {
                        el.classList.add('hidden');
                        el.classList.remove('flex');
                    }
                }
            });
        }

        function showLoginScreen() {
            showScreen('loginScreen');
        }

        function showCreateRoomScreen() {
            showScreen('createRoomScreen');
        }

        function showRoomScreen(roomId, videoUrl, isHost) {
            showScreen('roomScreen');
            document.getElementById('mainVideo').src = videoUrl;
            document.getElementById('mainVideo').load(); // Ù„Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ

            // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¶ÙŠÙ
            if (isHost) {
                document.getElementById('hostControls').classList.remove('hidden');
                document.getElementById('hostControls').classList.add('flex');
                document.getElementById('deleteRoomBtn').classList.remove('hidden');
            } else {
                document.getElementById('hostControls').classList.add('hidden');
                document.getElementById('hostControls').classList.remove('flex');
                document.getElementById('deleteRoomBtn').classList.add('hidden');
            }

            // Ø¥Ø®ÙØ§Ø¡ Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø£Ø³ÙÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ù…ØµØºØ±Ø© Ø§Ù„Ø¢Ù†)
            document.getElementById('chatContainer').classList.add('hidden');
            
            updateUserAvatar(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø© ÙÙŠ Ø´Ø§Ø´Ø© Ø§Ù„ØºØ±ÙØ©
        }
        
        // ØªÙ… Ø­Ø°Ù Ø¯Ø§Ù„Ø© handleResize
        // window.addEventListener('resize', handleResize);


        // --- Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ / Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ ---

        function handleLogin() {
            const name = document.getElementById('userName').value.trim();
            if (!name) {
                showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…Ùƒ.');
                return;
            }
            
            saveUserProfile({ name: name }).then(() => {
                const urlParams = new URLSearchParams(window.location.search);
                const roomIdFromUrl = urlParams.get('room');
                
                if (roomIdFromUrl) {
                    attemptJoinRoom(roomIdFromUrl);
                } else {
                    showCreateRoomScreen();
                }
            }).catch(e => {
                console.error("Login failed:", e);
                showToast('ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù…ØªØ§Ø¨Ø¹Ø©.');
            });
        }
        
        function handleAvatarUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    updatePreviewAvatar(e.target.result);
                };
                reader.readAsDataURL(file);
            }
        }
        
        function handleNewAvatarUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    // Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø´ÙƒÙ„ Ù…Ø¤Ù‚Øª ÙÙŠ Ø§Ù„Ù€ modal
                    // (Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ø±Ø¶ Ù…Ø¨Ø§Ø´Ø± Ù„Ù„ØµÙˆØ±Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ØŒ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØªÙ‡ Ù‡Ù†Ø§ Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±)
                    // Ù„ÙƒÙ† Ø¯Ø§Ù„Ø© saveAvatar Ø³ØªÙ‚ÙˆÙ… Ø¨Ø§Ù„Ø±ÙØ¹ Ø§Ù„ÙØ¹Ù„ÙŠ ÙˆØ§Ù„ØªØ­Ø¯ÙŠØ«
                };
                reader.readAsDataURL(file);
            }
        }

        async function uploadAvatarFile(file) {
            if (!file) return null;

            const avatarPath = `artifacts/${appId}/public/data/avatars/${userId}/${file.name}`;
            const storageRef = ref(storage, avatarPath);

            try {
                await uploadBytes(storageRef, file);
                return await getDownloadURL(storageRef);
            } catch (error) {
                console.error("Failed to upload avatar:", error);
                showToast('ÙØ´Ù„ ÙÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©.');
                return null;
            }
        }

        function showChangeNameModal() {
            document.getElementById('newNameInput').value = currentUser.name;
            document.getElementById('changeNameModal').classList.remove('hidden');
            hideMenu();
        }

        function hideChangeNameModal() {
            document.getElementById('changeNameModal').classList.add('hidden');
        }

        async function saveName() {
            const newName = document.getElementById('newNameInput').value.trim();
            if (!newName) {
                showToast('Ø§Ù„Ø§Ø³Ù… Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† ÙØ§Ø±ØºØ§Ù‹.');
                return;
            }
            await saveUserProfile({ name: newName });
            hideChangeNameModal();
            showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø§Ø³Ù… Ø¨Ù†Ø¬Ø§Ø­.');
        }

        function showChangeAvatarModal() {
            document.getElementById('changeAvatarModal').classList.remove('hidden');
            hideMenu();
        }

        function hideChangeAvatarModal() {
            document.getElementById('changeAvatarModal').classList.add('hidden');
            document.getElementById('newAvatarInput').value = null;
        }

        async function saveAvatar() {
            const input = document.getElementById('newAvatarInput');
            const file = input.files[0];

            if (file) {
                const newAvatarUrl = await uploadAvatarFile(file);
                if (newAvatarUrl) {
                    await saveUserProfile({ avatar: newAvatarUrl });
                    updatePreviewAvatar(newAvatarUrl);
                    hideChangeAvatarModal();
                    showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„.');
                }
            } else {
                hideChangeAvatarModal();
            }
        }

        function updateUserAvatar() {
            const avatarEl = document.getElementById('roomUserAvatar');
            const nameEl = document.getElementById('roomUserName');
            
            nameEl.textContent = currentUser.name || 'Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¬Ù‡ÙˆÙ„';
            
            if (currentUser.avatar) {
                avatarEl.innerHTML = `<img src="${currentUser.avatar}" class="w-8 h-8 object-cover rounded-full">`;
                avatarEl.className = 'w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold';
            } else {
                avatarEl.innerHTML = (currentUser.name && currentUser.name.length > 0) ? currentUser.name[0].toUpperCase() : 'ğŸ‘¤';
                avatarEl.className = 'w-8 h-8 rounded-full avatar-pattern flex items-center justify-center text-sm font-bold';
            }
        }

        // --- Ù…Ø¹Ø§Ù„Ø¬Ø© Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ© (ØªÙ… ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª ÙÙŠ Firestore) ---
        
        function getRoomRef(id) {
            return doc(db, `/artifacts/${appId}/rooms/${id}`);
        }
        
        function getRoomVideosCollectionRef(roomId) {
            return collection(db, `/artifacts/${appId}/rooms/${roomId}/videos`);
        }
        
        function getRoomVideoRef(roomId, videoId) {
            return doc(db, `/artifacts/${appId}/rooms/${roomId}/videos/${videoId}`);
        }
        
        function getRoomParticipantsCollectionRef(roomId) {
            return collection(db, `/artifacts/${appId}/rooms/${roomId}/participants`);
        }
        
        function getRoomParticipantRef(roomId, userId) {
             return doc(db, `/artifacts/${appId}/rooms/${roomId}/participants/${userId}`);
        }
        
        function getRoomMessagesCollectionRef(roomId) {
             return collection(db, `/artifacts/${appId}/rooms/${roomId}/messages`);
        }
        
        let selectedVideoForRoom = null;

        function handleVideoUpload(event) {
            const file = event.target.files[0];
            const createBtn = document.getElementById('createRoomBtn');
            const progressMessage = document.getElementById('progressMessage');
            
            if (file) {
                selectedVideoForRoom = file;
                createBtn.disabled = false;
                progressMessage.textContent = `Ø¬Ø§Ù‡Ø² Ù„Ø±ÙØ¹: ${file.name}`;
                progressMessage.classList.remove('hidden', 'text-red-400');
                progressMessage.classList.add('text-gray-300');
            } else {
                selectedVideoForRoom = null;
                createBtn.disabled = true;
                progressMessage.textContent = '';
                progressMessage.classList.add('hidden');
            }
        }

        async function uploadVideoFile(file, roomId, videoId, isInitial = false) {
            if (!file) return null;

            const videoPath = `artifacts/${appId}/data/rooms/${roomId}/videos/${videoId}/${file.name}`;
            const storageRef = ref(storage, videoPath);
            const uploadTask = uploadBytesResumable(storageRef, file);
            
            // Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø© Ø§Ù„Ø±ÙØ¹ Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø¬Ø§Ø±ÙŠØ©
            currentUploads[videoId] = { 
                file: file,
                progress: 0,
                status: 'uploading',
                task: uploadTask,
                isInitial: isInitial 
            };
            
            const roomVideoRef = getRoomVideoRef(roomId, videoId);

            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙÙŠ Firestore
            await setDoc(roomVideoRef, {
                id: videoId,
                name: file.name,
                uploaderId: userId,
                uploadedAt: new Date(),
                status: 'uploading',
                path: videoPath,
                videoUrl: null, // Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
            }, { merge: true });

            return new Promise((resolve, reject) => {
                uploadTask.on('state_changed', 
                    (snapshot) => {
                        // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… (Ù„Ø´Ø§Ø´Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ© Ø£Ùˆ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª)
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        if (isInitial) {
                            document.getElementById('uploadPercentage').textContent = `${Math.round(progress)}%`;
                            document.getElementById('progressBar').style.width = `${progress}%`;
                            document.getElementById('progressContainer').classList.remove('hidden');
                        }
                        
                        // ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„ Ø§Ù„Ø±ÙØ¹ Ø§Ù„Ø¬Ø§Ø±ÙŠ
                        currentUploads[videoId].progress = progress;
                        if (!isInitial) {
                            renderVideosList(roomVideosCache); // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
                        }
                    }, 
                    (error) => {
                        console.error("Upload failed:", error);
                        delete currentUploads[videoId];
                        setDoc(roomVideoRef, { status: 'failed', error: error.message }, { merge: true });
                        showToast('ÙØ´Ù„ ÙÙŠ Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ.');
                        document.getElementById('createRoomBtn').disabled = false;
                        document.getElementById('addVideoBtn').disabled = !isHost;
                        renderVideosList(roomVideosCache);
                        reject(error);
                    }, 
                    async () => {
                        const videoUrl = await getDownloadURL(uploadTask.snapshot.ref);
                        delete currentUploads[videoId];
                        
                        // ØªØ­Ø¯ÙŠØ« Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù€ Firestore (Ø­Ø§Ù„Ø©: uploaded)
                        await setDoc(roomVideoRef, { 
                            status: 'uploaded', 
                            videoUrl: videoUrl,
                            thumbnailUrl: null // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚ Ù„Ø¥Ù†Ø´Ø§Ø¡ ØµÙˆØ±Ø© Ù…ØµØºØ±Ø© Ù„Ø§Ø­Ù‚Ù‹Ø§
                        }, { merge: true });

                        if (isInitial) {
                            document.getElementById('progressContainer').classList.add('hidden');
                            document.getElementById('progressMessage').textContent = 'ØªÙ… Ø§Ù„Ø±ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­.';
                        }
                        
                        showToast(`ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ù†Ø¬Ø§Ø­: ${file.name}`);
                        document.getElementById('createRoomBtn').disabled = false;
                        document.getElementById('addVideoBtn').disabled = !isHost;
                        renderVideosList(roomVideosCache);
                        resolve(videoUrl);
                    }
                );
            });
        }


        async function createRoom() {
            if (!selectedVideoForRoom || !currentUser || !currentUser.name) return;

            document.getElementById('createRoomBtn').disabled = true;
            document.getElementById('progressMessage').textContent = 'Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ© ÙˆØ±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ...';
            document.getElementById('progressMessage').classList.remove('hidden');
            
            const newRoomId = generateId(10);
            const initialVideoId = generateId(15);

            try {
                // 1. Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø£ÙˆÙ„ÙŠ
                const videoUrl = await uploadVideoFile(selectedVideoForRoom, newRoomId, initialVideoId, true);
                
                // 2. Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„ØºØ±ÙØ©
                const roomData = {
                    hostId: userId,
                    createdAt: new Date(),
                    status: ROOM_STATUS_ACTIVE,
                    currentVideoId: initialVideoId, 
                    currentVideoUrl: videoUrl,
                    playbackState: {
                        isPlaying: false,
                        time: 0,
                        lastUpdated: Date.now(),
                        updatedBy: userId,
                        syncCount: 0 
                    },
                    participantsCount: 0 // Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡ Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†
                };

                await setDoc(getRoomRef(newRoomId), roomData);
                
                // 3. Ø§Ù†Ø¶Ù…Ø§Ù… Ø§Ù„Ù…Ø¶ÙŠÙ Ù„Ù„ØºØ±ÙØ©
                isHost = true;
                currentRoomId = newRoomId;
                await joinRoom(newRoomId, videoUrl, initialVideoId); // ØªÙ…Ø±ÙŠØ± initialVideoId
                
                // 4. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙŠ Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
                history.pushState(null, '', `?room=${newRoomId}`);
                
            } catch (error) {
                console.error("Error creating room or uploading video:", error);
                showToast('ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©.');
                document.getElementById('createRoomBtn').disabled = false;
                document.getElementById('progressContainer').classList.add('hidden');
                document.getElementById('progressMessage').textContent = 'ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹.';
                document.getElementById('progressMessage').classList.add('text-red-400');
            }
        }


        // --- Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØºØ±ÙØ© ---

        async function attemptJoinRoom(roomId) {
            try {
                const roomSnap = await getDoc(getRoomRef(roomId));
                
                if (!roomSnap.exists()) {
                    showToast('Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© Ø£Ùˆ Ø§Ù†ØªÙ‡Øª.');
                    history.pushState(null, '', window.location.pathname); // Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±Ø§Ù…ØªØ±
                    showCreateRoomScreen();
                    return;
                }
                
                const roomData = roomSnap.data();
                
                if (roomData.status !== ROOM_STATUS_ACTIVE) {
                    showToast('Ø§Ù„ØºØ±ÙØ© Ø§Ù†ØªÙ‡Øª.');
                    history.pushState(null, '', window.location.pathname); 
                    showCreateRoomScreen();
                    return;
                }

                // ØªØ­Ø¯ÙŠØ¯ Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‡Ùˆ Ø§Ù„Ù…Ø¶ÙŠÙ
                isHost = (roomData.hostId === userId);
                currentRoomId = roomId;
                roomHostIdCache = roomData.hostId;
                currentVideoId = roomData.currentVideoId;

                // Ø§Ù†Ø¶Ù…Ø§Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„ØºØ±ÙØ©
                await joinRoom(roomId, roomData.currentVideoUrl, roomData.currentVideoId);
                
            } catch (error) {
                console.error("Error attempting to join room:", error);
                showToast('ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØºØ±ÙØ©.');
                showCreateRoomScreen();
            }
        }

        async function joinRoom(roomId, videoUrl, videoId) {
            // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© Ø§Ù„ØºØ±ÙØ©
            showRoomScreen(roomId, videoUrl, isHost);
            
            // 1. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© ÙÙŠ Firestore
            const participantRef = getRoomParticipantRef(roomId, userId);
            const participantData = {
                id: userId,
                name: currentUser.name,
                avatar: currentUser.avatar || null,
                joinedAt: Date.now(),
                lastSeen: Date.now(),
            };
            await setDoc(participantRef, participantData);
            
            // 2. Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹ÙŠ Firestore
            setupRoomListeners(roomId, videoId);
            
            // 3. ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø´Ø§Ø±Ùƒ ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©
            const participantInterval = setInterval(async () => {
                await setDoc(participantRef, { lastSeen: Date.now() }, { merge: true });
            }, 30000);
            unsubscribes.push(() => clearInterval(participantInterval)); // Ø­ÙØ¸ Ø§Ù„Ø¯Ø§Ù„Ø© Ù„Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
        }
        
        // --- Ø¥Ø¯Ø§Ø±Ø© Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„ØºØ±ÙØ© (Firebase Realtime Updates) ---
        
        function setupRoomListeners(roomId, videoId) {
            // Ø¥Ù„ØºØ§Ø¡ Ø£ÙŠ Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ø³Ø§Ø¨Ù‚Ø©
            unsubscribes.forEach(unsub => unsub());
            unsubscribes = [];
            
            // 1. Ù…Ø³ØªÙ…Ø¹ Ø­Ø§Ù„Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø©) - Ù„ÙƒÙ„ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†
            const roomUnsub = onSnapshot(getRoomRef(roomId), (doc) => {
                const room = doc.data();
                if (room) {
                    currentRoomId = doc.id; // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ ID Ù„Ù„ØªØ£ÙƒØ¯
                    roomHostIdCache = room.hostId; // ØªØ­Ø¯ÙŠØ« Ù‡ÙˆÙŠØ© Ø§Ù„Ù…Ø¶ÙŠÙ
                    
                    // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø¥Ø°Ø§ ØªØºÙŠØ±Øª Ø§Ù„Ø­Ø§Ù„Ø©
                    if (room.currentVideoId !== currentVideoId) {
                         // ØªØºÙŠÙŠØ± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ø´ØºÙ„ Ø­Ø§Ù„ÙŠØ§Ù‹
                         currentVideoId = room.currentVideoId;
                         document.getElementById('mainVideo').src = room.currentVideoUrl;
                         document.getElementById('mainVideo').load();
                         // Ù…Ø²Ø§Ù…Ù†Ø© ÙÙˆØ±ÙŠØ© Ø¨Ø¹Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù…ØµØ¯Ø±
                         syncPlayback(room.playbackState, true); 
                    }
                    
                    // Ù…Ø²Ø§Ù…Ù†Ø© Ø­Ø§Ù„Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ ÙˆØ§Ù„Ø¥ÙŠÙ‚Ø§Ù ÙˆØ§Ù„ÙˆÙ‚Øª (Ø¹Ø¯Ù… Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¥Ø°Ø§ ÙƒÙ†Øª Ø£Ù†Øª Ø§Ù„Ù…Ø¶ÙŠÙ Ø§Ù„Ø°ÙŠ Ø£Ø¬Ø±Ù‰ Ø§Ù„ØªØºÙŠÙŠØ±)
                    if (!isHost || room.playbackState.updatedBy !== userId) {
                        syncPlayback(room.playbackState);
                    }
                    
                    // Ø¥Ø°Ø§ Ø§Ù†ØªÙ‡Øª Ø§Ù„ØºØ±ÙØ© Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø¶ÙŠÙ
                    if (room.status === ROOM_STATUS_ENDED) {
                        showToast('Ù‚Ø§Ù… Ø§Ù„Ù…Ø¶ÙŠÙ Ø¨Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©.');
                        leaveRoom(false); // Ø®Ø±ÙˆØ¬ Ø¯ÙˆÙ† Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­Ø°Ù
                    }

                } else {
                    // Ø¥Ø°Ø§ ØªÙ… Ø­Ø°Ù Ø§Ù„ØºØ±ÙØ© Ù…Ù† Firestore
                    showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„ØºØ±ÙØ© Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø¶ÙŠÙ.');
                    leaveRoom(false);
                }
            }, (error) => {
                console.error("Room listener failed:", error);
                showToast('Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….');
                leaveRoom(false); 
            });
            unsubscribes.push(roomUnsub);
            
            // 2. Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† (Ù„Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† ÙˆØ§Ù„Ø¹Ø¯Ø¯)
            const participantsUnsub = onSnapshot(getRoomParticipantsCollectionRef(roomId), (snapshot) => {
                let participants = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    // Ø­Ø°Ù Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† ØºÙŠØ± Ø§Ù„Ù†Ø´Ø·ÙŠÙ† (Ù„Ù… ÙŠØªÙØ§Ø¹Ù„ÙˆØ§ Ù„Ø£ÙƒØ«Ø± Ù…Ù† 5 Ø¯Ù‚Ø§Ø¦Ù‚)
                    if (Date.now() - data.lastSeen < 5 * 60 * 1000) {
                        participants.push(data);
                    } else if (doc.id !== userId && doc.id !== roomHostIdCache) {
                        // Ø­Ø°Ù Ø§Ù„Ù…Ø´Ø§Ø±Ùƒ Ø¥Ø°Ø§ ÙƒØ§Ù† ØºÙŠØ± Ù†Ø´Ø· ÙˆÙ„ÙŠØ³ Ø§Ù„Ù…Ø¶ÙŠÙ Ø£Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
                        deleteDoc(getRoomParticipantRef(roomId, doc.id)).catch(e => console.error("Failed to clean up participant:", e));
                    }
                });
                
                // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                document.getElementById('participantsCount').textContent = participants.length;
                renderParticipantsList(participants);
            }, (error) => {
                 console.error("Participants listener failed:", error);
            });
            unsubscribes.push(participantsUnsub);
            
            // 3. Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© (Ø§Ù„Ø±Ø³Ø§Ø¦Ù„)
            const chatQuery = query(getRoomMessagesCollectionRef(roomId), orderBy("timestamp", "asc"));
            const chatUnsub = onSnapshot(chatQuery, (snapshot) => {
                let messages = [];
                snapshot.forEach(doc => messages.push(doc.data()));
                renderMessages(messages);
            }, (error) => {
                 console.error("Chat listener failed:", error);
            });
            unsubscribes.push(chatUnsub);
            
            // 4. Ù…Ø³ØªÙ…Ø¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª (Ù„Ø¥Ø¯Ø§Ø±Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª)
            const videosQuery = query(getRoomVideosCollectionRef(roomId), orderBy("uploadedAt", "desc"));
            const videosUnsub = onSnapshot(videosQuery, (snapshot) => {
                let videos = [];
                snapshot.forEach(doc => videos.push(doc.data()));
                renderVideosList(videos);
            }, (error) => {
                 console.error("Videos listener failed:", error);
            });
            unsubscribes.push(videosUnsub);
            
            // 5. Ù…Ø³ØªÙ…Ø¹ Ù„Ù…Ù„Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø§Ù„Ù…Ø¶ÙŠÙ
            if (!isHost) {
                 const videoEl = document.getElementById('mainVideo');
                 
                 // Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙˆÙ† Ù„Ø¹Ø¯Ù… Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ù…Ø´Ø§Ø±Ùƒ Ø¨Ø§Ù„ØªØ­ÙƒÙ… Ù…Ø¨Ø§Ø´Ø±Ø©
                 videoEl.addEventListener('play', preventPlaybackControl);
                 videoEl.addEventListener('pause', preventPlaybackControl);
                 videoEl.addEventListener('seeking', preventPlaybackControl);
                 videoEl.addEventListener('seeked', preventPlaybackControl);

                 unsubscribes.push(() => {
                    videoEl.removeEventListener('play', preventPlaybackControl);
                    videoEl.removeEventListener('pause', preventPlaybackControl);
                    videoEl.removeEventListener('seeking', preventPlaybackControl);
                    videoEl.removeEventListener('seeked', preventPlaybackControl);
                 });
            }
        }
        
        function preventPlaybackControl(e) {
             if (!isHost) {
                const videoEl = document.getElementById('mainVideo');
                // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø§Ù„Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¥Ù„Ù‰ Ù…Ø§ ØªÙ…Ù„ÙŠÙ‡ Ø­Ø§Ù„Ø© Ø§Ù„ØºØ±ÙØ© (Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø©)
                if (e.type === 'play') videoEl.pause();
                if (e.type === 'pause') videoEl.play();
                if (e.type === 'seeking') videoEl.currentTime = videoEl.lastTime || 0;
                e.preventDefault();
                e.stopImmediatePropagation();
             }
        }


        // --- Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (Host Only) ---
        
        let syncTimeout = null;
        let lastUpdateTime = 0;
        const SYNC_COOLDOWN = 500; // 500ms Ø¨ÙŠÙ† ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©

        // Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¨ÙŠÙ† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ùˆ Firestore (Ù„Ù„Ù…Ø¶ÙŠÙ)
        async function updatePlaybackState() {
            if (!isHost || !currentRoomId) return;

            const now = Date.now();
            if (now - lastUpdateTime < SYNC_COOLDOWN) {
                // Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ Ø§Ù†ØªÙ‡Ø§Ø¡ ÙØªØ±Ø© Ø§Ù„ØªÙ‡Ø¯Ø¦Ø©
                if (syncTimeout) clearTimeout(syncTimeout);
                syncTimeout = setTimeout(updatePlaybackState, SYNC_COOLDOWN - (now - lastUpdateTime) + 50);
                return;
            }
            lastUpdateTime = now;
            
            const videoEl = document.getElementById('mainVideo');
            
            const newState = {
                isPlaying: !videoEl.paused,
                time: videoEl.currentTime,
                lastUpdated: now,
                updatedBy: userId,
                syncCount: firebase.increment(1) // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«
            };
            
            try {
                // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ ÙÙŠ Firestore
                await setDoc(getRoomRef(currentRoomId), { playbackState: newState }, { merge: true });
            } catch (error) {
                console.error("Failed to update playback state:", error);
            }
        }

        // Ù…Ø³ØªÙ…Ø¹Ø§Øª ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ø¶ÙŠÙ Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø©
        function setupHostVideoListeners() {
            const videoEl = document.getElementById('mainVideo');
            
            // ÙŠØ¬Ø¨ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ updatePlaybackState Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
            videoEl.addEventListener('play', updatePlaybackState);
            videoEl.addEventListener('pause', updatePlaybackState);
            videoEl.addEventListener('seeked', updatePlaybackState);

            // Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„ØºØ±ÙØ©ØŒ Ù†Ø²ÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙ…Ø¹Ø§Øª
            unsubscribes.push(() => {
                videoEl.removeEventListener('play', updatePlaybackState);
                videoEl.removeEventListener('pause', updatePlaybackState);
                videoEl.removeEventListener('seeked', updatePlaybackState);
            });
        }
        
        // --- Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (Host Only) ---
        
        function togglePlayPause() {
            if (!isHost) return;
            const videoEl = document.getElementById('mainVideo');
            if (videoEl.paused) {
                videoEl.play();
            } else {
                videoEl.pause();
            }
            // Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø³ØªØ­Ø¯Ø« Ø¹Ø¨Ø± Ù…Ø³ØªÙ…Ø¹ 'play' Ø£Ùˆ 'pause'
            updatePlayPauseButton(videoEl.paused);
        }
        
        function seekVideo(seconds) {
            if (!isHost) return;
            const videoEl = document.getElementById('mainVideo');
            videoEl.currentTime += seconds;
            // Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø³ØªØ­Ø¯Ø« Ø¹Ø¨Ø± Ù…Ø³ØªÙ…Ø¹ 'seeked'
        }

        function updatePlayPauseButton(isPaused) {
            const btn = document.getElementById('playPauseBtn');
            if (isPaused) {
                // Ø±Ù…Ø² Ø§Ù„ØªØ´ØºÙŠÙ„ (Ù…Ø«Ù„Ø«)
                btn.innerHTML = '<svg class="w-6 h-6" fill="currentColor" viewbox="0 0 24 24"><path d="M8 5v14l11-7z" /></svg>';
            } else {
                // Ø±Ù…Ø² Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø¤Ù‚Øª (Ø´Ø±Ø·ØªØ§Ù†)
                btn.innerHTML = '<svg class="w-6 h-6" fill="currentColor" viewbox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z" /></svg>';
            }
        }

        // --- Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (Client/Viewer) ---
        
        function syncPlayback(state, forced = false) {
            const videoEl = document.getElementById('mainVideo');

            if (!videoEl || !state) return;

            // 1. Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªØ´ØºÙŠÙ„/Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù
            const shouldBePlaying = state.isPlaying;
            if (shouldBePlaying && videoEl.paused) {
                videoEl.play().catch(e => console.log("Auto-play blocked:", e));
            } else if (!shouldBePlaying && !videoEl.paused) {
                videoEl.pause();
            }

            // 2. Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ÙˆÙ‚Øª
            const latency = (Date.now() - state.lastUpdated) / 1000;
            let targetTime = state.time + (shouldBePlaying ? latency : 0);
            
            // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„ÙˆÙ‚Øª Ù„Ø§ ÙŠØªØ¬Ø§ÙˆØ² Ù…Ø¯Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
            if (videoEl.duration) {
                targetTime = Math.min(targetTime, videoEl.duration);
            }
            
            const timeDifference = Math.abs(videoEl.currentTime - targetTime);

            // Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙØ±Ù‚ Ø£ÙƒØ¨Ø± Ù…Ù† 1.5 Ø«Ø§Ù†ÙŠØ© Ø£Ùˆ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…Ø²Ø§Ù…Ù†Ø© Ù‚Ø³Ø±ÙŠØ© (Ø¨Ø¹Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ)
            if (timeDifference > 1.5 || forced) {
                videoEl.currentTime = targetTime;
            }
            
            // ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„ØªØ´ØºÙŠÙ„/Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù Ù„Ù„Ù…Ø¶ÙŠÙ Ù†ÙØ³Ù‡ (Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø±Ø¶Ù‡ Ù„Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©)
            if (isHost) {
                updatePlayPauseButton(videoEl.paused);
            }
        }
        
        // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† ---

        function renderParticipantsList(participants) {
            const listEl = document.getElementById('participantsList');
            const countEl = document.getElementById('modalParticipantsCount');
            listEl.innerHTML = '';
            countEl.textContent = participants.length;
            
            participants.sort((a, b) => {
                // Ø§Ù„Ù…Ø¶ÙŠÙ Ø£ÙˆÙ„Ø§Ù‹
                if (a.id === roomHostIdCache) return -1;
                if (b.id === roomHostIdCache) return 1;
                // Ø«Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
                if (a.id === userId) return -1;
                if (b.id === userId) return 1;
                // Ø£Ø¨Ø¬Ø¯ÙŠØ§Ù‹ Ø¨Ø§Ù„Ø§Ø³Ù…
                return a.name.localeCompare(b.name);
            }).forEach(p => {
                const isHostDisplay = p.id === roomHostIdCache ? '<span class="text-xs bg-purple-500/50 px-2 py-0.5 rounded-full mr-2">Ø§Ù„Ù…Ø¶ÙŠÙ</span>' : '';
                const isMeDisplay = p.id === userId ? '<span class="text-xs bg-green-500/50 px-2 py-0.5 rounded-full mr-2">Ø£Ù†Øª</span>' : '';
                
                const avatarHTML = createAvatarHTML(p.avatar, p.name, 'w-10 h-10');
                
                const participantEl = document.createElement('div');
                participantEl.className = 'flex items-center p-3 bg-white/5 rounded-xl shadow';
                participantEl.innerHTML = `
                    <div class="flex-shrink-0 ml-3">
                        ${avatarHTML}
                    </div>
                    <div class="flex-1">
                        <p class="font-semibold text-white">${p.name}</p>
                        <p class="text-sm text-gray-400 flex items-center mt-0.5">
                            ${isHostDisplay}
                            ${isMeDisplay}
                        </p>
                    </div>
                `;
                listEl.appendChild(participantEl);
            });
        }
        
        function showParticipantsModal() {
            document.getElementById('participantsModal').classList.remove('hidden');
            hideMenu();
        }

        function hideParticipantsModal() {
            document.getElementById('participantsModal').classList.add('hidden');
        }

        // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ---
        
        function renderMessages(messages) {
            const chatEl = document.getElementById('chatMessages');
            const compactChatEl = document.getElementById('compactChatMessages');
            
            // Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            const shouldScroll = chatEl.scrollHeight - chatEl.clientHeight <= chatEl.scrollTop + 50; 
            const shouldScrollCompact = compactChatEl.scrollHeight - compactChatEl.clientHeight <= compactChatEl.scrollTop + 50; 

            chatEl.innerHTML = '';
            compactChatEl.innerHTML = '';

            messages.forEach(msg => {
                const isMine = msg.userId === userId;
                const alignmentClass = isMine ? 'justify-end' : 'justify-start';
                const bubbleClass = isMine ? 'bg-purple-600 text-white rounded-tr-none' : 'bg-gray-700 text-white rounded-tl-none';
                
                const avatarHTML = createAvatarHTML(msg.avatar, msg.userName, 'w-8 h-8');

                const messageHTML = `
                    <div class="flex ${alignmentClass} chat-message">
                        ${!isMine ? `<div class="flex-shrink-0 ml-3">${avatarHTML}</div>` : ''}
                        <div class="max-w-xs sm:max-w-sm">
                            <p class="text-xs font-semibold mb-1 ${isMine ? 'text-right' : 'text-left'}">${msg.userName}</p>
                            <div class="px-4 py-2 ${bubbleClass} rounded-2xl shadow-lg break-words">
                                ${msg.text}
                            </div>
                        </div>
                        ${isMine ? `<div class="flex-shrink-0 mr-3">${avatarHTML}</div>` : ''}
                    </div>
                `;
                chatEl.innerHTML += messageHTML;
                compactChatEl.innerHTML += messageHTML;
            });
            
            // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø£Ø³ÙÙ„ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‚Ø±ÙŠØ¨Ø§Ù‹ Ù…Ù† Ø§Ù„Ø£Ø³ÙÙ„
            if (shouldScroll) {
                chatEl.scrollTop = chatEl.scrollHeight;
            }
            if (shouldScrollCompact) {
                 compactChatEl.scrollTop = compactChatEl.scrollHeight;
            }
        }
        
        function createAvatarHTML(avatarUrl, name, sizeClass) {
             let innerHTML;
             let classNames = sizeClass + ' rounded-full flex items-center justify-center text-sm font-bold flex-shrink-0';
             
             if (avatarUrl) {
                 innerHTML = `<img src="${avatarUrl}" class="w-full h-full object-cover rounded-full">`;
                 classNames = sizeClass + ' rounded-full flex items-center justify-center text-sm font-bold flex-shrink-0';
             } else {
                 innerHTML = (name && name.length > 0) ? name[0].toUpperCase() : 'ğŸ‘¤';
                 classNames += ' avatar-pattern';
             }
             
             return `<div class="${classNames}">${innerHTML}</div>`;
        }


        async function sendMessage() {
            if (!currentRoomId) return;
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;

            const messageData = {
                userId: userId,
                userName: currentUser.name,
                avatar: currentUser.avatar || null,
                text: message,
                timestamp: Date.now()
            };

            try {
                await addDoc(getRoomMessagesCollectionRef(currentRoomId), messageData);
                input.value = '';
            } catch (error) {
                console.error("Failed to send message:", error);
                showToast('ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©.');
            }
        }
        
        function toggleChatVisibility() {
            const chatToggleBtn = document.getElementById('chatToggleBtn');
            const chatContainer = document.getElementById('chatContainer');
            
            if (chatContainer.classList.contains('hidden')) {
                // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
                chatContainer.classList.remove('hidden');
                chatVisible = true;
                // handleResize(); // ØªÙ… Ø­Ø°ÙÙ‡Ø§
                
                // ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø¥Ù„Ù‰ "Ø¥Ø®ÙØ§Ø¡"
                chatToggleBtn.innerHTML = `
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h.01M4 12h.01M4 16h.01M20 8h.01M20 12h.01M20 16h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.505A9.76 9.76 0 0112 4c4.97 0 9 3.582 9 8z"/>
                    </svg>
                `;
            } else {
                // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
                chatContainer.classList.add('hidden');
                chatVisible = false;
                // handleResize(); // ØªÙ… Ø­Ø°ÙÙ‡Ø§
                
                // ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø¥Ù„Ù‰ "Ø¥Ø¸Ù‡Ø§Ø±"
                chatToggleBtn.innerHTML = `
                     <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.505A9.76 9.76 0 0112 4c4.97 0 9 3.582 9 8z"/>
                     </svg>
                 `;
            }
        }


        // --- ÙˆØ¸Ø§Ø¦Ù Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª / Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØºØ±ÙØ© ---

        function toggleMenu() {
            document.getElementById('menuOverlay').classList.toggle('hidden');
        }
        
        function hideMenu() {
            document.getElementById('menuOverlay').classList.add('hidden');
        }

        function copyRoomLink() {
            const roomLink = `${window.location.origin}${window.location.pathname}?room=${currentRoomId}`;
            navigator.clipboard.writeText(roomLink).then(() => {
                showToast('ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„ØºØ±ÙØ©.');
            }).catch(err => {
                console.error("Failed to copy link:", err);
                showToast('ÙØ´Ù„ ÙÙŠ Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·.');
            });
            hideMenu();
        }
        
        function showDeleteConfirmModal() {
            document.getElementById('deleteConfirmModal').classList.remove('hidden');
            hideMenu();
        }

        function hideDeleteConfirmModal() {
            document.getElementById('deleteConfirmModal').classList.add('hidden');
        }
        
        function handleDeleteRoom() {
            showDeleteConfirmModal();
        }

        async function handleDeleteRoomConfirmed() {
            if (!isHost || !currentRoomId) return;

            hideDeleteConfirmModal();
            showToast('Ø¬Ø§Ø±ÙŠ Ø­Ø°Ù Ø§Ù„ØºØ±ÙØ© ÙˆØ­Ø°Ù Ù…Ù„Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ...');
            
            try {
                // 1. ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ØºØ±ÙØ© Ø¥Ù„Ù‰ Ù…Ù†ØªÙ‡ÙŠØ©
                await setDoc(getRoomRef(currentRoomId), { status: ROOM_STATUS_ENDED }, { merge: true });

                // 2. Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ù„Ø­Ø°ÙÙ‡Ø§ Ù…Ù† Storage
                const videosSnapshot = await getDocs(getRoomVideosCollectionRef(currentRoomId));
                const deletePromises = [];

                videosSnapshot.forEach(doc => {
                    const videoData = doc.data();
                    if (videoData.path) {
                        const fileRef = ref(storage, videoData.path);
                        // Ø¥Ø¶Ø§ÙØ© ÙˆØ¹Ø¯ Ø­Ø°Ù Ù…Ù„Ù Storage
                        deletePromises.push(deleteObject(fileRef).catch(e => console.warn(`Failed to delete storage file ${videoData.path}:`, e)));
                    }
                    // Ø¥Ø¶Ø§ÙØ© ÙˆØ¹Ø¯ Ø­Ø°Ù ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ù† Firestore
                    deletePromises.push(deleteDoc(getRoomVideoRef(currentRoomId, doc.id)).catch(e => console.warn(`Failed to delete video doc ${doc.id}:`, e)));
                });
                
                // 3. Ø­Ø°Ù ÙˆØ«Ø§Ø¦Ù‚ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† (Ø§Ø®ØªÙŠØ§Ø±ÙŠØŒ Ø§Ù„Ù…Ø³ØªÙ…Ø¹ ÙŠÙ‚ÙˆÙ… Ø¨Ø­Ø°ÙÙ‡Ù… Ø¨Ø´ÙƒÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙŠ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©)
                const participantsSnapshot = await getDocs(getRoomParticipantsCollectionRef(currentRoomId));
                participantsSnapshot.forEach(doc => {
                    deletePromises.push(deleteDoc(getRoomParticipantRef(currentRoomId, doc.id)).catch(e => console.warn(`Failed to delete participant doc ${doc.id}:`, e)));
                });
                
                // 4. Ø­Ø°Ù ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„ØºØ±ÙØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                deletePromises.push(deleteDoc(getRoomRef(currentRoomId)));

                // Ø§Ù†ØªØ¸Ø§Ø± Ø§ÙƒØªÙ…Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø­Ø°Ù
                await Promise.all(deletePromises);
                
                showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„ØºØ±ÙØ© ÙˆØ§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ù†Ø¬Ø§Ø­.');
                leaveRoom(false); // Ø§Ù„Ø®Ø±ÙˆØ¬ Ù„Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©

            } catch (error) {
                console.error("Error deleting room:", error);
                showToast('ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„ØºØ±ÙØ© Ø¨Ø´ÙƒÙ„ ÙƒØ§Ù…Ù„.');
                leaveRoom(false);
            }
        }
        
        async function leaveRoom(cleanup = true) {
            if (currentRoomId && userId && cleanup) {
                try {
                    // Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†
                    await deleteDoc(getRoomParticipantRef(currentRoomId, userId));
                } catch (error) {
                    console.error("Failed to clean up participant:", error);
                }
            }
            
            // Ø¥Ù„ØºØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª ÙˆØ§Ù„Ù…Ø¤Ù‚ØªØ§Øª
            unsubscribes.forEach(unsub => unsub());
            unsubscribes = [];
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
            currentRoomId = null;
            isHost = false;
            roomHostIdCache = null;
            currentVideoId = null;
            
            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù€ compact chat
            hideCompactChat(); 
            
            // Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø´Ø§Ø´Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ© ÙˆÙ…Ø³Ø­ Ø±Ø§Ø¨Ø· Ø§Ù„ØºØ±ÙØ© Ù…Ù† Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
            history.pushState(null, '', window.location.pathname);
            showCreateRoomScreen();
        }

        // --- ÙˆØ¸Ø§Ø¦Ù Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª ---
        
        let roomVideosCache = [];

        function showVideosModal() {
            document.getElementById('videosModal').classList.remove('hidden');
            document.getElementById('addVideoBtn').disabled = !isHost; // ØªØ¹Ø·ÙŠÙ„ Ø²Ø± Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù„ØºÙŠØ± Ø§Ù„Ù…Ø¶ÙŠÙÙŠÙ†
            hideMenu();
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙÙˆØ±Ø§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­
            renderVideosList(roomVideosCache);
        }

        function hideVideosModal() {
            document.getElementById('videosModal').classList.add('hidden');
            document.getElementById('additionalVideoInput').value = null; // Ù…Ø³Ø­ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ù„Ù
        }
        
        async function handleAdditionalVideoUpload(event) {
             const file = event.target.files[0];
             document.getElementById('additionalVideoInput').value = null; // Ù…Ø³Ø­ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
             
             if (!file || !isHost || !currentRoomId) return;

             document.getElementById('addVideoBtn').disabled = true;
             
             const newVideoId = generateId(15);
             
             try {
                // Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙˆØ¥Ø¶Ø§ÙØªÙ‡ Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„ØºØ±ÙØ©
                await uploadVideoFile(file, currentRoomId, newVideoId, false);
             } catch(error) {
                showToast(`ÙØ´Ù„ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ: ${file.name}`);
             } finally {
                document.getElementById('addVideoBtn').disabled = !isHost;
             }
        }


        function renderVideosList(videos) {
            const listEl = document.getElementById('videosList');
            listEl.innerHTML = '';
            roomVideosCache = videos; // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ cache

            if (videos.length === 0) {
                listEl.innerHTML = '<p class="text-gray-400 text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ù…Ø­Ù…Ù„Ø© Ø¨Ø¹Ø¯.</p>';
                return;
            }

            videos.forEach(video => {
                const isCurrent = video.id === currentVideoId;
                const isUploading = currentUploads[video.id] && currentUploads[video.id].status === 'uploading';
                const isFailed = video.status === 'failed';
                
                let statusText = '';
                let buttonHTML = '';
                let progressHTML = '';
                
                if (isCurrent) {
                    statusText = '<span class="text-xs bg-blue-500/50 px-2 py-0.5 rounded-full mr-2">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¹Ø±Ø¶</span>';
                    buttonHTML = `<button disabled class="bg-gray-600/50 text-white px-3 py-1 rounded-lg text-sm transition-colors disabled:opacity-50">Ù‚ÙŠØ¯ Ø§Ù„Ø¹Ø±Ø¶</button>`;
                } else if (isUploading) {
                    const progress = currentUploads[video.id].progress || 0;
                    statusText = `<span class="text-xs bg-yellow-500/50 px-2 py-0.5 rounded-full mr-2">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹</span>`;
                    progressHTML = `
                        <div class="mt-2 w-full bg-gray-700 rounded-full h-1.5">
                            <div class="bg-yellow-500 h-1.5 rounded-full" style="width: ${progress}%"></div>
                        </div>
                        <p class="text-xs text-yellow-300 mt-1">${Math.round(progress)}% Ù…ÙƒØªÙ…Ù„</p>
                    `;
                    buttonHTML = `<button disabled class="bg-gray-600/50 text-white px-3 py-1 rounded-lg text-sm disabled:opacity-50">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹</button>`;
                } else if (isFailed) {
                    statusText = `<span class="text-xs bg-red-500/50 px-2 py-0.5 rounded-full mr-2">ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹</span>`;
                    buttonHTML = `<button data-video-id="${video.id}" data-action="delete" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-lg text-sm transition-colors disabled:opacity-50" ${isHost ? '' : 'disabled'}>Ø­Ø°Ù</button>`;
                } else {
                    statusText = `<span class="text-xs bg-green-500/50 px-2 py-0.5 rounded-full mr-2">Ø¬Ø§Ù‡Ø²</span>`;
                    buttonHTML = `<button data-video-id="${video.id}" data-action="play" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded-lg text-sm transition-colors disabled:opacity-50" ${isHost ? '' : 'disabled'}>ØªØ´ØºÙŠÙ„</button>`;
                }
                
                const deleteBtn = `<button data-video-id="${video.id}" data-action="delete" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-lg text-sm transition-colors mr-2 disabled:opacity-50" ${isHost && !isCurrent ? '' : 'disabled'}>Ø­Ø°Ù</button>`;

                const videoEl = document.createElement('div');
                videoEl.className = 'p-4 bg-white/5 rounded-xl shadow';
                videoEl.innerHTML = `
                    <p class="font-semibold text-white truncate mb-1">${video.name}</p>
                    <div class="flex items-center text-sm text-gray-400 mb-2">
                        ${statusText}
                    </div>
                    ${progressHTML}
                    <div class="mt-3 flex justify-end">
                         ${deleteBtn}
                         ${isHost && !isUploading && !isFailed ? buttonHTML : ''}
                    </div>
                `;
                
                listEl.appendChild(videoEl);
            });
            
            // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© (ØªØ´ØºÙŠÙ„/Ø­Ø°Ù)
            listEl.querySelectorAll('button').forEach(button => {
                if (!button.disabled) {
                    button.addEventListener('click', handleVideoListAction);
                }
            });
        }
        
        async function handleVideoListAction(event) {
            const button = event.target;
            const videoId = button.dataset.videoId;
            const action = button.dataset.action;
            
            if (!videoId || !currentRoomId || !isHost) return;
            
            hideVideosModal();

            if (action === 'play') {
                await switchVideo(videoId);
            } else if (action === 'delete') {
                await deleteRoomVideo(videoId);
            }
        }
        
        async function switchVideo(videoId) {
            const video = roomVideosCache.find(v => v.id === videoId);
            if (!video || video.status !== 'uploaded') return;

            showToast(`Ø¬Ø§Ø±ÙŠ ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¥Ù„Ù‰: ${video.name}`);
            
            try {
                // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ØºØ±ÙØ© Ø¨Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø¬Ø¯ÙŠØ¯
                const newState = {
                    currentVideoId: videoId,
                    currentVideoUrl: video.videoUrl,
                    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ Ù„Ù„Ø¨Ø¯Ø§ÙŠØ© (Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø¤Ù‚Øª Ø¹Ù†Ø¯ 0)
                    playbackState: {
                        isPlaying: false,
                        time: 0,
                        lastUpdated: Date.now(),
                        updatedBy: userId,
                        syncCount: firebase.increment(1)
                    }
                };

                await setDoc(getRoomRef(currentRoomId), newState, { merge: true });
                // Ø³ÙŠØªÙ… Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨ÙˆØ§Ø³Ø·Ø© Ù…Ø³ØªÙ…Ø¹ Ø§Ù„ØºØ±ÙØ© ÙˆØ§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
                showToast('ØªÙ… ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ù†Ø¬Ø§Ø­.');

            } catch (error) {
                console.error("Failed to switch video:", error);
                showToast('ÙØ´Ù„ ÙÙŠ ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ.');
            }
        }
        
        async function deleteRoomVideo(videoId) {
            const video = roomVideosCache.find(v => v.id === videoId);
            if (!video || video.id === currentVideoId) return; // Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù‚ÙŠØ¯ Ø§Ù„Ø¹Ø±Ø¶

             showToast(`Ø¬Ø§Ø±ÙŠ Ø­Ø°Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ: ${video.name}`);
             
             try {
                // 1. Ø­Ø°Ù Ù…Ù„Ù Storage
                if (video.path) {
                    const fileRef = ref(storage, video.path);
                    await deleteObject(fileRef).catch(e => console.warn(`Failed to delete storage file ${video.path}:`, e));
                }
                
                // 2. Ø­Ø°Ù ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ù† Firestore
                await deleteDoc(getRoomVideoRef(currentRoomId, videoId));
                
                showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ù†Ø¬Ø§Ø­.');
                // Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ø¨Ø± Ø§Ù„Ù…Ø³ØªÙ…Ø¹
             } catch (error) {
                console.error("Failed to delete video:", error);
                showToast('ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ.');
             }
        }

        // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
 </body>
</html>
